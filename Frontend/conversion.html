<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>FormatForge | Convert</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">

  <link rel="stylesheet" href="index.css">
</head>

<body class="theme-glass d-flex flex-column">

  <!-- BACKGROUND -->
  <div class="bg-image"></div>
  <div class="bg-blur"></div>

  <!-- NAVBAR -->
  <div id="navbar-container"></div>

  <!-- ================= CENTER UI ================= -->
  <main class="flex-grow-1 d-flex align-items-center justify-content-center"
        style="padding-top:80px; padding-bottom:80px;">
    <section class="w-100">
      <div class="container">

        <h2 class="text-center text-white mb-4">
          Upload Your Images
        </h2>

        <div class="row justify-content-center">
          <div class="col-md-6">

            <div class="glass-overlay text-center">

              <!-- ðŸš« NO FORM -->
              <input
                type="file"
                class="form-control mb-3"
                id="fileInput"
                accept="image/*"
                multiple
              >

              <!-- PREVIEW -->
              <div id="previewContainer"
                   class="d-flex flex-wrap gap-2 justify-content-center mb-3">
              </div>

              <!-- âœ… PURE JS BUTTON -->
              <button
                id="convertBtn"
                class="btn btn-primary w-100"
              >
                Convert to PDF
              </button>

              <!-- STATUS -->
              <div id="status" class="mt-3 text-center"></div>

              <!-- DOWNLOAD -->
              <a id="downloadBtn" class="btn btn-success w-100 mt-3 d-none">
                Download PDF
              </a>

            </div>

          </div>
        </div>

      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="bg-dark text-white text-center py-3 fixed-bottom">
    Â© 2025 FORMATFORGE | Final Year Project
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- ================= SCRIPT ================= -->
  <script>
    let enhanceEnabled = true;

    /* LOAD NAVBAR */
    fetch("navbar.html")
      .then(r => r.text())
      .then(html => document.getElementById("navbar-container").innerHTML = html);

    /* BLOCK ENTER KEY COMPLETELY */
    document.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
      }
    });

    /* PREVIEW */
    const fileInput = document.getElementById("fileInput");
    const preview = document.getElementById("previewContainer");

    fileInput.addEventListener("change", () => {
      preview.innerHTML = "";
      [...fileInput.files].forEach(file => {
        const r = new FileReader();
        r.onload = e => {
          const img = document.createElement("img");
          img.src = e.target.result;
          img.style.width = "90px";
          img.style.height = "90px";
          img.style.objectFit = "cover";
          img.style.borderRadius = "8px";
          preview.appendChild(img);
        };
        r.readAsDataURL(file);
      });
    });

    const toBase64 = file =>
      new Promise(res => {
        const r = new FileReader();
        r.onload = () => res(r.result);
        r.readAsDataURL(file);
      });

    /* CONVERT */
    document.getElementById("convertBtn").addEventListener("click", async () => {
      const files = [...fileInput.files];
      const status = document.getElementById("status");
      const download = document.getElementById("downloadBtn");

      if (!files.length) {
        status.innerHTML = "<span class='text-danger'>Select images first</span>";
        return;
      }

      status.innerText = "Processing images...";

      const images = [];
      for (const f of files) images.push(await toBase64(f));

      status.innerText = "Sending to server...";

      fetch("http://127.0.0.1:8000/convert-to-pdf", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ images, enhance: enhanceEnabled })
      })
        .then(r => r.json())
        .then(d => {
          download.href = "data:application/pdf;base64," + d.pdf;
          download.download = "formatforge.pdf";
          download.classList.remove("d-none");
          status.innerHTML = "<span class='text-success'>Done!</span>";
        })
        .catch(() => {
          status.innerHTML = "<span class='text-danger'>Server error</span>";
        });
    });
  </script>

</body>
</html>
